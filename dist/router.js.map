{"version":3,"sources":["../src/router.js"],"names":["resize","require","AppRouter","app","initRouter","date","Date","year","getFullYear","monthIndex","getMonth","day","getDate","dateStr","uploadDir","get","upload","post","req","res","next","console","log","body","headers","Accept","then","data","msg","rtn","reserve","status","json","received","failed","catch","err","message","_activities","activities","EvtResBed","getCurrentDateString","_meal","meal","fs","filePath","join","serverJson","JSON","parse","readFileSync","allowed","password","params","oldpw","content","newpw","writeFileSync","stringify","changed","verified","array","fileName","update","name","existsSync","download","fileNameArray","split","fileType","toLowerCase","ValidImageTypes","includes","sizeOf","dimensions","i","width","height","Math","floor","pipe","unlinkSync","deleted","addZeroIfSingle","num","String"],"mappings":"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","file":"router.js","sourcesContent":["import {version} from '../package.json';\r\nimport path from 'path';\r\nimport axios from 'axios';\r\n\r\nvar resize = require('./resize');\r\n\r\nclass AppRouter {\r\n\r\n  constructor(app){\r\n    this.app = app;\r\n    this.initRouter();\r\n  }\r\n\r\n  getDateString() {\r\n    let date = new Date();\r\n    let year = date.getFullYear();\r\n    let monthIndex = date.getMonth() + 1;\r\n    let day = date.getDate();\r\n\r\n    let dateStr = year + '-' + monthIndex + '-' + day;\r\n    return dateStr;\r\n  }\r\n\r\n  initRouter(){\r\n\r\n    const app = this.app;\r\n    const uploadDir = app.get('storageDir');\r\n    const upload = app.get('upload');\r\n\r\n    /*app.get('/', (req,res,next)=>{\r\n      return res.status(200).json({\r\n        version: version\r\n      })\r\n    });*/\r\n\r\n    app.post('/api/updEvtErl', async(req,res,next)=>{\r\n      console.log(req.body);\r\n      /*const data = req.body;\r\n      const body = {\r\n        'MEMID': data.MEMID,\r\n        'CTRID': 'JCH',\r\n        'EvtCod': data.EvtCod,\r\n        'ErlName': data.ErlName,\r\n        'ErlDat': this.getDateString(),\r\n        'IsMbr': '1',\r\n        'ErlPhone': '12345678',\r\n        'EvtCosID': '1',\r\n        'EvtAct': data.Reserve?'RSVD':'CANN'\r\n      };*/\r\n\r\n      axios.post('http://10.0.48.22/EHMS/api/updEvtErl/', req.body, {\r\n        headers: {\r\n          Accept: 'application/x-www-form-json',\r\n          'Content-Type': 'application/x-www-form-urlencoded'\r\n        }\r\n      }).then(res =>{\r\n        console.log(res.data.msg);\r\n        //console.log(json);\r\n        if(res.data.rtn === \"0\"){\r\n          if(reserve){\r\n            //ToastAndroid.show('已成功留位!',ToastAndroid.SHORT);\r\n            return res.status(200).json({\r\n              received: false\r\n            });\r\n          }else{\r\n            //ToastAndroid.show('已取消留位!',ToastAndroid.SHORT);\r\n\r\n            return res.status(200).json({\r\n              received: true\r\n            });\r\n          }\r\n        }else{\r\n          console.log(\"Failed to reserve\");\r\n          return res.status(404).json({\r\n            failed: true\r\n          });\r\n        }\r\n\r\n      }).catch(err=>{\r\n        console.log(err.message);\r\n        return res.status(404).json({\r\n          failed: true\r\n        });\r\n        //ToastAndroid.show('錯誤!',ToastAndroid.SHORT);\r\n      });\r\n    });\r\n\r\n    app.get('/api/activities', async (req,res,next)=>{\r\n      var _activities = await axios.get('http://10.0.48.22/EHMS/api/getEvtResBed/');\r\n      ///console.log(_meal.data)\r\n      return res.status(200).json({\r\n        activities: _activities.data.EvtResBed\r\n      });\r\n    });\r\n\r\n\r\n    app.get('/api/todayMeal', async (req,res,next)=>{\r\n      var _meal = await axios.get('http://10.0.48.22/EHMS/API/getDiet/' + this.getCurrentDateString());\r\n      ///console.log(_meal.data)\r\n      return res.status(200).json({\r\n        meal: _meal.data\r\n      });\r\n    });\r\n\r\n    app.get('/api/changepw/:oldpw/:newpw',(req,res,next) =>{\r\n        const fs = require('fs');\r\n        const filePath = path.join(uploadDir,'server.json');\r\n        var serverJson = JSON.parse(fs.readFileSync(filePath, 'utf8'));\r\n        //console.log(serverJson);\r\n        var allowed = serverJson.password === req.params.oldpw? true:false;\r\n\r\n        if(allowed){\r\n          const content = {\r\n            password: req.params.newpw\r\n          };\r\n          const fs = require('fs');\r\n          const filePath = path.join(uploadDir,\"server.json\");\r\n\r\n          fs.writeFileSync(filePath,JSON.stringify(content,null,4));\r\n        }\r\n\r\n        return res.json({\r\n          changed: allowed\r\n        });\r\n      });\r\n\r\n    app.get('/api/login/:password',(req,res,next)=>{\r\n\r\n      const fs = require('fs');\r\n      const filePath = path.join(uploadDir,'server.json');\r\n      var serverJson = JSON.parse(fs.readFileSync(filePath, 'utf8'));\r\n      //console.log(serverJson);\r\n      var allowed = serverJson.password === req.params.password? true:false;\r\n\r\n      return res.json({\r\n        verified: allowed\r\n      })\r\n    });\r\n\r\n    app.post('/api/upload',upload.array('files'), (req,res, next)=>{\r\n      //console.log('Received file', req.files);\r\n      return res.json({\r\n        status: 'ok'\r\n        //files: req.files\r\n      })\r\n    });\r\n\r\n    app.post('/api/update/:fileName/:json',(req,res, next)=>{\r\n      //console.log('Received json');\r\n      const content = JSON.parse(req.params.json);\r\n      const fs = require('fs');\r\n      const filePath = path.join(uploadDir,req.params.fileName);\r\n\r\n      fs.writeFileSync(filePath,JSON.stringify(content,null,4));\r\n      return res.json({\r\n        update: content\r\n      });\r\n    });\r\n\r\n    app.get('/api/download/:name', (req,res,next)=>{\r\n\r\n      var fileName = req.params.name;\r\n      var filePath = path.join(uploadDir,fileName);\r\n\r\n      const fs = require('fs');\r\n      if(!fs.existsSync(filePath)){\r\n        filePath = path.join(uploadDir,'no_image.png');\r\n        return res.download(filePath,'no_image.png',(err)=>{});\r\n      }\r\n\r\n      console.log('donwloading ' + fileName);\r\n\r\n      var fileNameArray = fileName.split('.');\r\n      var fileType = fileNameArray[1].toLowerCase();\r\n      //console.log(fileType)\r\n      var ValidImageTypes = [\"jpeg\", \"png\",\"jpg\",\"JPG\",\"PNG\"];\r\n      if (ValidImageTypes.includes(fileType)) {\r\n        console.log('resizing');\r\n\r\n        var sizeOf = require('image-size');\r\n        var dimensions = sizeOf(filePath);\r\n        //console.log(dimensions.width, dimensions.height);\r\n        for(var i=0;i<100;i++){\r\n          dimensions.width *= 0.98;\r\n          dimensions.height *= 0.98;\r\n          if(dimensions.width < 512 || dimensions.height < 512){\r\n            break;\r\n          }\r\n        }\r\n\r\n        //res.type('image/png');\r\n        resize(filePath,fileType,Math.floor(dimensions.width),Math.floor(dimensions.height)).pipe(res);\r\n      }else {\r\n        console.log('not resizing')\r\n        return res.download(filePath,fileName,(err)=>{\r\n          if(err){\r\n            //console.log('File download error')\r\n          }else{\r\n            //console.log('File download available')\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    app.get('/api/delete/:name', (req,res,next)=>{\r\n      const fileName = req.params.name;\r\n      const filePath = path.join(uploadDir,fileName);\r\n      var fs = require('fs');\r\n      try{\r\n        fs.unlinkSync(filePath);\r\n      }\r\n      catch(err){\r\n        console.log('Non-existing file removing: ' + fileName)\r\n      }\r\n      console.log('file removed: ' + fileName)\r\n      res.json({\r\n        deleted: true\r\n      });\r\n    });\r\n\r\n    console.log('App router initialized');\r\n  }\r\n\r\n  getCurrentDateString() {\r\n    let date = new Date();\r\n    let year = date.getFullYear();\r\n    let monthIndex = date.getMonth() + 1;\r\n    let day = date.getDate();\r\n\r\n    let dateStr = year + '-' + this.addZeroIfSingle(monthIndex) + '-' + this.addZeroIfSingle(day);\r\n    //console.log(dateStr);\r\n    //return '2018-02-08';\r\n    return dateStr;\r\n  }\r\n\r\n  addZeroIfSingle(num){\r\n    if(num < 10){\r\n      return '0' + String(num);\r\n    }else{\r\n      return '' + String(num);\r\n    }\r\n  }\r\n\r\n}\r\n\r\nexport default AppRouter;\r\n"]}